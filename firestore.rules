rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ─────────────────────────────────────────────
       Helper functions
       ───────────────────────────────────────────── */

    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return get(
        /databases/$(database)/documents/users/$(request.auth.uid)
      ).data;
    }

    function isAdmin() {
      return isSignedIn()
        && userDoc().role == "admin";
    }

    function hasValidTargetingFields() {
      return userDoc().department is string
        && userDoc().year is int;
    }

    function isExplicitRecipient(event) {
      return event.explicitRecipients is list
        && event.explicitRecipients.hasAny([request.auth.uid]);
    }

    function matchesRuleGroup(group) {
      return hasValidTargetingFields()
        && group.department == userDoc().department
        && group.years is list
        && group.years.hasAny([userDoc().year]);
    }

    /*
      Firestore Rules DO NOT support:
      - arrow functions
      - .any()
      So we must check rule groups by index safely.
    */
    function matchesAnyRule(event) {
      return event.targetingRules is list
        && (
          (event.targetingRules.size() > 0
            && matchesRuleGroup(event.targetingRules[0]))
          ||
          (event.targetingRules.size() > 1
            && matchesRuleGroup(event.targetingRules[1]))
          ||
          (event.targetingRules.size() > 2
            && matchesRuleGroup(event.targetingRules[2]))
          ||
          (event.targetingRules.size() > 3
            && matchesRuleGroup(event.targetingRules[3]))
          ||
          (event.targetingRules.size() > 4
            && matchesRuleGroup(event.targetingRules[4]))
        );
    }

    function isPublicEvent(event) {
      return !(event.targetingRules is list)
        || event.targetingRules.size() == 0;
    }

    function canUserReadEvent(event) {
      return isPublicEvent(event)
        || isExplicitRecipient(event)
        || matchesAnyRule(event);
    }

    /* ─────────────────────────────────────────────
       Users collection
       ───────────────────────────────────────────── */

    match /users/{uid} {

      allow read: if isSignedIn()
        && (request.auth.uid == uid || isAdmin());

      allow update: if request.auth.uid == uid
        && !("role" in request.resource.data)
        && !("department" in request.resource.data)
        && !("year" in request.resource.data);

      allow create: if isSignedIn()
        && request.auth.uid == uid;

      allow delete: if false;
    }

    /* ─────────────────────────────────────────────
       Events collection (SINGLE SOURCE OF TRUTH)
       ───────────────────────────────────────────── */

    match /events/{eventId} {

      allow read: if isAdmin()
        || (isSignedIn() && canUserReadEvent(resource.data));

      allow create, update, delete: if isAdmin();
    }

    /* ─────────────────────────────────────────────
       Notifications (Option A)
       users/{uid}/notifications/{eventId}
       ───────────────────────────────────────────── */

    match /users/{uid}/notifications/{eventId} {

      allow read: if isSignedIn()
        && request.auth.uid == uid;

      allow create, update, delete: if isAdmin();
    }
  }
}
